<!-- templates/sdr_dashboard.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDR Spectrum Analyzer - Mode R√âEL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-900 text-gray-100">
    <div class="container mx-auto px-4 py-8">
        <!-- En-t√™te -->
        <div class="mb-8 text-center">
            <h1 class="text-4xl font-bold mb-2">
                <i class="fas fa-satellite-dish text-blue-400 mr-3"></i>
                SDR Spectrum Analyzer
            </h1>
            <p class="text-gray-400">Surveillance RF en temps r√©el - Mode R√âEL</p>
            <div id="status" class="mt-4"></div>
        </div>

        <!-- Dashboard -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Contr√¥les -->
            <div class="bg-gray-800 rounded-xl p-6 shadow-lg border border-blue-700/50">
                <h3 class="text-xl font-bold mb-4 text-blue-300">
                    <i class="fas fa-sliders-h mr-2"></i>Contr√¥les
                </h3>
                <div class="space-y-4">
                    <button id="scan-all" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold transition">
                        <i class="fas fa-search mr-2"></i>Scanner toutes les fr√©quences
                    </button>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <button data-freq="4625" class="freq-btn bg-red-700 hover:bg-red-800 text-white py-2 rounded">
                            <i class="fas fa-fighter-jet mr-1"></i>4625 kHz
                        </button>
                        <button data-freq="11175" class="freq-btn bg-orange-600 hover:bg-orange-700 text-white py-2 rounded">
                            <i class="fas fa-satellite mr-1"></i>11175 kHz
                        </button>
                        <button data-freq="2182" class="freq-btn bg-green-700 hover:bg-green-800 text-white py-2 rounded">
                            <i class="fas fa-life-ring mr-1"></i>2182 kHz
                        </button>
                        <button data-freq="6000" class="freq-btn bg-purple-700 hover:bg-purple-800 text-white py-2 rounded">
                            <i class="fas fa-broadcast-tower mr-1"></i>6000 kHz
                        </button>
                    </div>
                    
                    <div class="mt-4">
                        <label class="block text-sm mb-2">Fr√©quence personnalis√©e (kHz)</label>
                        <div class="flex">
                            <input type="number" id="custom-freq" value="7000" 
                                   class="flex-1 bg-gray-700 border border-gray-600 rounded-l-lg p-3 text-white">
                            <button id="scan-custom" class="bg-purple-600 hover:bg-purple-700 text-white px-4 rounded-r-lg">
                                <i class="fas fa-bullseye"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- R√©sultats -->
            <div class="bg-gray-800 rounded-xl p-6 shadow-lg border border-green-700/50">
                <h3 class="text-xl font-bold mb-4 text-green-300">
                    <i class="fas fa-chart-line mr-2"></i>R√©sultats en temps r√©el
                </h3>
                <div id="results" class="space-y-3">
                    <div class="text-center p-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-400 mx-auto mb-2"></div>
                        <p class="text-gray-400">En attente de donn√©es...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Serveurs -->
        <div class="bg-gray-800 rounded-xl p-6 shadow-lg mb-8">
            <h3 class="text-xl font-bold mb-4 text-yellow-300">
                <i class="fas fa-server mr-2"></i>Serveurs SDR Actifs
            </h3>
            <div id="servers" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Charg√© dynamiquement -->
            </div>
        </div>

        <!-- Console -->
        <div class="bg-gray-900 rounded-xl p-6 shadow-lg border border-gray-700">
            <h3 class="text-xl font-bold mb-4 text-blue-300">
                <i class="fas fa-terminal mr-2"></i>Console SDR
            </h3>
            <div id="console" class="h-48 overflow-y-auto bg-black rounded-lg p-4 font-mono text-sm">
                <div class="text-green-400">>>> Initialisation du syst√®me SDR...</div>
            </div>
        </div>
    </div>

    <script>
        class SDRDashboard {
            static async initialize() {
                console.log('üì° Initialisation SDR Dashboard...');
                await this.checkStatus();
                await this.loadServers();
                this.setupEventListeners();
            }

            static async checkStatus() {
                try {
                    const response = await fetch('/api/sdr/status');
                    const data = await response.json();
                    
                    const statusDiv = document.getElementById('status');
                    if (!statusDiv) return;
                    
                    if (data.service_available) {
                        statusDiv.innerHTML = `
                            <div class="inline-block px-6 py-3 rounded-full bg-green-900/50 border border-green-700">
                                <div class="flex items-center">
                                    <i class="fas fa-satellite-dish text-green-400 mr-3 text-xl"></i>
                                    <div>
                                        <div class="font-bold text-green-300">üåê MODE R√âEL ACTIV√â</div>
                                        <div class="text-sm text-green-400">
                                            ${data.active_servers} serveurs actifs
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        statusDiv.innerHTML = `
                            <div class="inline-block px-6 py-3 rounded-full bg-red-900/50 border border-red-700">
                                <div class="flex items-center">
                                    <i class="fas fa-exclamation-triangle text-red-400 mr-3 text-xl"></i>
                                    <div>
                                        <div class="font-bold text-red-300">‚ùå MODE SIMULATION</div>
                                        <div class="text-sm text-red-400">
                                            Activez GEOPOL_REAL_MODE=true dans .env
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Erreur statut:', error);
                }
            }

            static async loadServers() {
                try {
                    const response = await fetch('/api/sdr/servers');
                    const data = await response.json();
                    
                    const container = document.getElementById('servers');
                    if (!container) return;
                    
                    if (data.success && data.servers.length > 0) {
                        container.innerHTML = data.servers.map(server => `
                            <div class="bg-gray-700/50 rounded-lg p-4 border ${server.status === 'active' ? 'border-green-700' : 'border-gray-600'}">
                                <div class="font-bold ${server.status === 'active' ? 'text-green-300' : 'text-gray-400'}">
                                    <i class="fas fa-${server.type === 'websdr' ? 'wifi' : 'server'} mr-2"></i>
                                    ${server.name}
                                </div>
                                <div class="text-sm text-gray-400 truncate">${server.url}</div>
                                <div class="text-xs text-gray-500 mt-1">${server.location}</div>
                                <div class="mt-2">
                                    <span class="px-2 py-1 rounded text-xs ${server.status === 'active' ? 'bg-green-900 text-green-300' : 'bg-gray-800 text-gray-400'}">
                                        ${server.status}
                                    </span>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = `
                            <div class="col-span-3 text-center p-4 text-gray-500">
                                <i class="fas fa-exclamation-circle mr-2"></i>
                                ${data.message || 'Aucun serveur disponible'}
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Erreur serveurs:', error);
                }
            }

            static async scanAll() {
                try {
                    this.log('üöÄ Lancement du scan complet...');
                    this.showNotification('Scan en cours...', 'info');
                    
                    const response = await fetch('/api/sdr/scan');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.showNotification(`‚úÖ Scan termin√©: ${data.stats.successful_scans} scans r√©ussis`, 'success');
                        this.log(`‚úÖ Scan termin√©: ${data.stats.successful_scans}/${data.stats.total_scans} r√©ussis`);
                        this.displayResults(data.results);
                    } else {
                        throw new Error(data.error || 'Erreur inconnue');
                    }
                } catch (error) {
                    this.showNotification(`‚ùå Erreur scan: ${error.message}`, 'error');
                    this.log(`‚ùå Erreur scan: ${error.message}`);
                }
            }

            static async scanFrequency(frequency) {
                try {
                    this.log(`üéØ Scan de ${frequency} kHz...`);
                    this.showNotification(`Scan ${frequency} kHz...`, 'info');
                    
                    const response = await fetch(`/api/sdr/frequency/${frequency}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        this.showNotification(`‚úÖ ${frequency} kHz analys√©`, 'success');
                        this.log(`‚úÖ ${frequency} kHz: ${data.analysis?.dominant_signal_type || 'N/A'}`);
                        this.displaySingleResult(data);
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    this.showNotification(`‚ùå Erreur ${frequency} kHz: ${error.message}`, 'error');
                    this.log(`‚ùå Erreur ${frequency} kHz: ${error.message}`);
                }
            }

            static displayResults(results) {
                const container = document.getElementById('results');
                if (!container || !results) return;
                
                let html = '';
                
                Object.entries(results).forEach(([category, scans]) => {
                    if (scans && scans.length > 0) {
                        html += `
                            <div class="mb-4">
                                <div class="font-bold text-blue-300 mb-2 uppercase">${category}</div>
                                <div class="space-y-2">
                        `;
                        
                        scans.forEach(scan => {
                            const freq = scan.frequency_khz;
                            const analysis = scan.analysis || {};
                            
                            html += `
                                <div class="bg-gray-700/30 rounded-lg p-3">
                                    <div class="flex justify-between items-center">
                                        <div class="font-medium">${freq} kHz</div>
                                        <div class="text-sm ${analysis.average_power_db > -60 ? 'text-green-400' : 'text-gray-400'}">
                                            ${analysis.average_power_db ? analysis.average_power_db.toFixed(1) + ' dB' : 'N/A'}
                                        </div>
                                        <button onclick="exportScanData()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg">
                                        <i class="fas fa-download mr-2"></i>Exporter
                                        </button>
                                    </div>
                                    <div class="text-sm text-gray-400">
                                        ${scan.description || 'Fr√©gence critique'}
                                        <span class="ml-2 px-2 py-0.5 bg-gray-800 rounded text-xs">
                                            ${analysis.dominant_signal_type || 'inconnu'}
                                        </span>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += `
                                </div>
                            </div>
                        `;
                    }
                });
                
                container.innerHTML = html || '<div class="text-gray-500 text-center">Aucun r√©sultat</div>';
            }

            static displaySingleResult(result) {
                const container = document.getElementById('results');
                if (!container) return;
                
                const analysis = result.analysis || {};
                
                container.innerHTML = `
                    <div class="bg-gray-700/30 rounded-lg p-4 border border-blue-700/50">
                        <div class="flex justify-between items-center mb-2">
                            <div class="font-bold text-xl">${result.frequency_khz} kHz</div>
                            <div class="text-lg ${analysis.average_power_db > -60 ? 'text-green-400' : 'text-yellow-400'}">
                                ${analysis.average_power_db ? analysis.average_power_db.toFixed(1) + ' dB' : 'N/A'}
                            </div>
                        </div>
                        <div class="text-sm text-gray-400 mb-3">
                            ${analysis.recommendation || 'Analyse termin√©e'}
                        </div>
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div class="bg-gray-800/50 rounded p-2">
                                <div class="text-blue-300">Serveurs</div>
                                <div class="text-xl">${result.servers_used || 0}</div>
                            </div>
                            <div class="bg-gray-800/50 rounded p-2">
                                <div class="text-green-300">Signaux</div>
                                <div class="text-xl">${analysis.signals_detected || 0}</div>
                            </div>
                            <div class="bg-gray-800/50 rounded p-2">
                                <div class="text-purple-300">Type</div>
                                <div class="text-sm">${analysis.dominant_signal_type || 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            static setupEventListeners() {
                // Scan complet
                const scanAllBtn = document.getElementById('scan-all');
                if (scanAllBtn) {
                    scanAllBtn.addEventListener('click', () => this.scanAll());
                }

                // Boutons de fr√©quence
                document.querySelectorAll('.freq-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const freq = e.target.closest('button').dataset.freq;
                        this.scanFrequency(parseInt(freq));
                    });
                });

                // Fr√©quence personnalis√©e
                const scanCustomBtn = document.getElementById('scan-custom');
                if (scanCustomBtn) {
                    scanCustomBtn.addEventListener('click', () => {
                        const input = document.getElementById('custom-freq');
                        const freq = parseInt(input.value);
                        if (freq > 0 && freq < 30000) {
                            this.scanFrequency(freq);
                        } else {
                            this.showNotification('‚ùå Fr√©quence invalide (1-30000 kHz)', 'error');
                        }
                    });
                }

                // Entr√©e sur le champ
                const customFreqInput = document.getElementById('custom-freq');
                if (customFreqInput) {
                    customFreqInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            scanCustomBtn.click();
                        }
                    });
                }
            }

            static log(message) {
                const consoleDiv = document.getElementById('console');
                if (!consoleDiv) return;
                
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = 'text-gray-300';
                logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${message}`;
                
                consoleDiv.appendChild(logEntry);
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
            }

            static showNotification(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 max-w-md ${
                    type === 'error' ? 'bg-red-600' :
                    type === 'success' ? 'bg-green-600' : 'bg-blue-600'
                } text-white`;
                
                toast.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 'check-circle'} mr-3"></i>
                        <div>${message}</div>
                    </div>
                `;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    if (toast.parentElement) toast.remove();
                }, 3000);
            }
        }

        // Auto-refresh du spectre
        let spectrumRefreshInterval = null;

        function startSpectrumAutoRefresh(intervalSeconds = 30) {
            if (spectrumRefreshInterval) {
                clearInterval(spectrumRefreshInterval);
            }

            spectrumRefreshInterval = setInterval(async () => {
                await refreshSpectrum();
            }, intervalSeconds * 1000);
        }

        async function refreshSpectrum() {
            try {
                const response = await fetch('/api/sdr/test-spectrum');
                const data = await response.json();

                if (data.success) {
                    updateSpectrumPlot(data);
                    SDRDashboard.log('üîÑ Spectre rafra√Æchi automatiquement');
                }
            } catch (error) {
                console.error('Erreur rafra√Æchissement spectre:', error);
            }
        }

        // Export des donn√©es
        function exportScanData() {
            const scans = document.querySelectorAll('#results > div');
            const exportData = [];

            scans.forEach(scan => {
                const freq = scan.querySelector('.font-medium')?.textContent;
                const power = scan.querySelector('.text-sm')?.textContent;

                if (freq && power) {
                    exportData.push({
                        frequency: freq.replace(' kHz', ''),
                        power: power,
                        timestamp: new Date().toISOString()
                    });
                }
            });

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

            const exportLink = document.createElement('a');
            exportLink.setAttribute('href', dataUri);
            exportLink.setAttribute('download', `sdr_scan_${Date.now()}.json`);
            document.body.appendChild(exportLink);
            exportLink.click();
            document.body.removeChild(exportLink);

            SDRDashboard.showNotification('‚úÖ Donn√©es export√©es', 'success');
        }
        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            SDRDashboard.initialize();
        });
    </script>
</body>
</html>